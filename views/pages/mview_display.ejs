<%- include("../partials/header") %>
 
<div class="container-fluid px-0 py-0" style="background-color: #212529; width:100%; height:100%; position:relative" controls id="viewer">
    <div class="row px-0 py-0 mx-auto" style="max-width:100%" id="row1">
        <% for(let i=1; i<= 2; i++) { %>
        <% iStr = "player" + i.toString() %>
        <% let d = i-1 %>
        <div class="col-xl-6 col-lg-12 px-0" id=<%="dropable"+d%>>
            <div class="item" draggable="true" ondragstart="drag(event)" ondrop="drop(event)" ondragover="allowDrop(event)" id=<%="vidPos"+ i.toString()%>>
                <video id=<%=iStr%>
                    controls
                    fluid  
                    class="cld-video-player">
                </video>
            </div>
        </div>
        <%}%>
    </div>
    
    <div class="row px-0 py-0 mx-auto" style="max-width:100%;max-height:35%" id="row2">
        <% for(let i=3; i<= 5; i++) { %>
        <% iStr = "player" + i.toString() %>
        <% let d = i-1 %>
        <div class="col-xl-4 col-lg-12 px-0" id=<%="dropable"+d%>>
            <div class="item" draggable="true" ondragstart="drag(event)" ondrop="drop(event)" ondragover="allowDrop(event)" id=<%="vidPos"+ i.toString()%>>
                <video id=<%=iStr%>
                    controls
                    fluid  
                    class="cld-video-player">
                </video>
            </div>
        </div>
        <%}%>
    </div>

    <br>

    <div class="border border-warning rounded-3 border-5 mx-auto p-0" style="width:99%; height:50; position:relative" id="playCntls">
        <div class="text-center m-0 p-0">
            <button class=" btn btn-default" id="mute-toggle-btn"><img src="mute.svg" alt="" width="40" id="muteToggleImg"></button>
            <button class="btn btn-default" id="fback-btn"> <img src= "./seekbackwards.svg" width="40" id="seekBackImg"/> </button>
            <button class=" btn btn-default" id="play-btn"><img src="./play.svg" alt="" width="40" id="playToggleImg"></button>
            <button class="btn btn-default" id="ffwd-btn"> <img src= "./seekforward.svg" width="40" id="seekFwdImg"/> </button>
            <button class=" btn btn-default" id="reset-btn"><img src="./sync.svg" alt="resync" width="40" id="syncImg"></button>
        </div>
    </div>
</div>

<div class="text-center pt-4">
    <div class="text-left fs-3" style="color:white">Match Name: <%=title%> </div>
    <div class="text-left fs-6" style="color:white">Created by <img src="<%=matchOwnerIcon%>" width="30"> <span style="color:red"><%=matchOwner%></span> on <%=ctime%>.</div>
</div>

<% if(numOfVideos==6) { %>

    <div id="vid1" data-video= '<%= video1 %>' hidden></div>
    <div id="vid2" data-video= '<%= video2 %>' hidden></div>
    <div id="vid3" data-video= '<%= video3 %>' hidden></div>
    <div id="vid4" data-video= '<%= video4 %>' hidden></div>
    <div id="vid5" data-video= '<%= video5 %>' hidden></div>
    <div id="vid6" data-video= '<%= video6 %>' hidden></div>

    <div id="st1" data-stime= '<%= stime1 %>' hidden></div>
    <div id="st2" data-stime= '<%= stime2 %>' hidden></div>
    <div id="st3" data-stime= '<%= stime3 %>' hidden></div>
    <div id="st4" data-stime= '<%= stime4 %>' hidden></div>
    <div id="st5" data-stime= '<%= stime5 %>' hidden></div>
    <div id="st6" data-stime= '<%= stime6 %>' hidden></div>

<%} else if(numOfVideos==5) { %>
    <div id="vid1" data-video= '<%= video1 %>' hidden></div>
    <div id="vid2" data-video= '<%= video2 %>' hidden></div>
    <div id="vid3" data-video= '<%= video3 %>' hidden></div>
    <div id="vid4" data-video= '<%= video4 %>' hidden></div>
    <div id="vid5" data-video= '<%= video5 %>' hidden></div>

    <div id="st1" data-stime= '<%= stime1 %>' hidden></div>
    <div id="st2" data-stime= '<%= stime2 %>' hidden></div>
    <div id="st3" data-stime= '<%= stime3 %>' hidden></div>
    <div id="st4" data-stime= '<%= stime4 %>' hidden></div>
    <div id="st5" data-stime= '<%= stime5 %>' hidden></div>

<%} else if(numOfVideos==4) { %>
    <div id="vid1" data-video= '<%= video1 %>' hidden></div>
    <div id="vid2" data-video= '<%= video2 %>' hidden></div>
    <div id="vid3" data-video= '<%= video3 %>' hidden></div>
    <div id="vid4" data-video= '<%= video4 %>' hidden></div>
    
    <div id="st1" data-stime= '<%= stime1 %>' hidden></div>
    <div id="st2" data-stime= '<%= stime2 %>' hidden></div>
    <div id="st3" data-stime= '<%= stime3 %>' hidden></div>
    <div id="st4" data-stime= '<%= stime4 %>' hidden></div>

<%} else if(numOfVideos==3) { %>
    <div id="vid1" data-video= '<%= video1 %>' hidden></div>
    <div id="vid2" data-video= '<%= video2 %>' hidden></div>
    <div id="vid3" data-video= '<%= video3 %>' hidden></div>

    <div id="st1" data-stime= '<%= stime1 %>' hidden></div>
    <div id="st2" data-stime= '<%= stime2 %>' hidden></div>
    <div id="st3" data-stime= '<%= stime3 %>' hidden></div>

    <div id="usr1" data-user= '<%= user1 %>' hidden></div>
    <div id="usr2" data-user= '<%= user2 %>' hidden></div>
    <div id="usr3" data-user= '<%= user3 %>' hidden></div>

    <div id="icon1" data-icon= '<%= icon1 %>' hidden></div>
    <div id="icon2" data-icon= '<%= icon2 %>' hidden></div>
    <div id="icon3" data-icon= '<%= icon3 %>' hidden></div>

<%} else if(numOfVideos==2) { %>
    <div id="vid1" data-video= '<%= video1 %>' hidden></div>
    <div id="vid2" data-video= '<%= video2 %>' hidden></div>

    <div id="st1" data-stime= '<%= stime1 %>' hidden></div>
    <div id="st2" data-stime= '<%= stime2 %>' hidden></div>

<%} else if(numOfVideos==1) { %>
    <div id="vid1" data-video= '<%= video1 %>' hidden></div>

    <div id="st1" data-stime= '<%= stime1 %>' hidden></div>

<%}%>

<div id="numOfVideos" data-num= '<%= numOfVideos %>' hidden></div>

<div id="cloudinary_name" data-num= '<%= cloudinary_name %>' hidden></div>

<script src="cld-video-player.min.js" 
    type="text/javascript"></script>


<!------------------- Start of Script ---------------------->   
<script type="text/javascript">
    let cloudinary_name = document.getElementById('cloudinary_name').getAttribute('data-num')

    let cld = cloudinary.Cloudinary.new({cloud_name: cloudinary_name})

    let numOfVideos = document.getElementById('numOfVideos').getAttribute('data-num')

    if(numOfVideos == 1){
        document.getElementById("fscreenImg").style.display = 'none'
        document.getElementById("playCntls").style.display = 'none'
    }

    //initialise players

    let player = []
    let playButton = (numOfVideos == 1)? true : false

    for(let v=1; v<=numOfVideos; v++) {
        player[v] = cld.videoPlayer('player'+v.toString(), 
        {
            loop: false,
            controls: true,
            autoplay: false,
            q_auto: true,
            show_logo: true,
            bigPlayButton: playButton,
            logoImageUrl: 'https://res.cloudinary.com/dvapwslkg/image/upload/v1659144864/multi/logo.ico',
            transformation:[
                {width:"720"},
                {crop: "crop"},
                // {color: '#FFFF00', overlay: {font_family: "Arial", font_size: 15, font_weight: "bold", letter_spacing: 5, text: ""+playerNames[v]}, background: "black"},
                // {flags: "layer_apply", gravity: "north_east", y: 20},

            ]
        })

    }

    //Source Videos
    for(let i=1; i<player.length; i++){
        player[i].source(document.getElementById('vid'+i).getAttribute('data-video'))
    }

    //Set up starttimes
    let startTimes = []
    for(let i=1; i<player.length; i++){
        startTimes[i] = document.getElementById('st'+i).getAttribute('data-stime')
        player[i].currentTime(startTimes[i])
    }

    //Play Toggle Control
    let playToggleBtn = document.getElementById("playToggleImg")

    playToggleBtn.addEventListener("click",()=> {
        if(playToggleBtn.getAttribute("src")== './play.svg') {
            playAll()
            playToggleBtn.src='./pause.svg'

        }
        else if(playToggleBtn.getAttribute("src")== './pause.svg') {
            pauseAll()
            playToggleBtn.src='./play.svg'
        }
    })

    //Mule Toggle Control
    let muteToggleBtn = document.getElementById("muteToggleImg")
    let muteOn = false

    muteToggleBtn.addEventListener("click",()=> {
        if(muteOn) {
            muteToggleBtn.src='./mute.svg'
            for(let i=1;i <player.length; i++) {
                player[i].currentTime(player[i].currentTime())
                player[i].unmute()
            }
        }
        else {
            muteToggleBtn.src='./unmute.svg'
            for(let i=1; i<player.length; i++){
                player[i].mute()
            }
        }

        muteOn = !muteOn

    })

    let durations = [0]
    let playTimes = [0]

    setInterval(()=>{
        for(let i=1; i<player.length; i++){
            durations[i] = player[i].duration()
            playTimes[i] = durations[i]-startTimes[i]
        }
    }, 1000)

    //End of play reset
    setInterval(endOfVideos, 100)
    function endOfVideos() {
        if(numOfVideos == 6 &&
            //check for end of all videos
            player[1].currentTime() == player[1].duration() &&
            player[2].currentTime() == player[2].duration() &&
            player[3].currentTime() == player[3].duration() &&
            player[4].currentTime() == player[4].duration() &&
            player[5].currentTime() == player[5].duration() &&
            player[6].currentTime() == player[6].duration()
            ) {
                playToggleBtn.src='./play.svg'
                startTime()
                playing = false
                playTimer= 0
        }
        else if(numOfVideos==5 &&
            //check for end of all videos
            player[1].currentTime() == player[1].duration() &&
            player[2].currentTime() == player[2].duration() &&
            player[3].currentTime() == player[3].duration() &&
            player[4].currentTime() == player[4].duration() &&
            player[5].currentTime() == player[5].duration() 
            ) {
                playToggleBtn.src='./play.svg'
                startTime()
                playing = false
                playTimer= 0
        }
        else if(numOfVideos==4 &&
            //check for end of all videos
            player[1].currentTime() == player[1].duration() &&
            player[2].currentTime() == player[2].duration() &&
            player[3].currentTime() == player[3].duration() &&
            player[4].currentTime() == player[4].duration() 
            ) {
                playToggleBtn.src='./play.svg'
                startTime()
                playing = false
                playTimer= 0
        }
        else if(numOfVideos==3 &&
            //check for end of all videos
            player[1].currentTime() == player[1].duration() &&
            player[2].currentTime() == player[2].duration() &&
            player[3].currentTime() == player[3].duration()  
            ) {
                playToggleBtn.src='./play.svg'
                startTime()
                playing = false
                playTimer= 0
        }
        else if(numOfVideos==2 &&
            //check for end of all videos
            player[1].currentTime() == player[1].duration() &&
            player[2].currentTime() == player[2].duration()  
            ) {
                playToggleBtn.src='./play.svg'
                startTime()
                playing = false
                playTimer= 0
        }
        else if(numOfVideos==1 &&
            //check for end of all videos
            player[1].currentTime() == player[1].duration()  
            ) {
                playToggleBtn.src='./play.svg'
                startTime()
                playing = false
                playTimer= 0
        }

    }

    //0.1 second play timer
    let playTimer = 0
    let maxPlayTime = 0 //max playtime

    setInterval(()=>{
        if(playing && !paused){
            maxPlayTime = Math.max(...playTimes.slice(1))
            if(playTimer < maxPlayTime){
                playTimer+=0.1
            }
        }
        //console.log(playTimer, maxPlayTime)
        
    }, 100)

    //Home button
    let homeBtn = document.getElementById("home")
    homeBtn.addEventListener("click",()=> {
        location.replace("/")
    })



    //helper functions
    let playing = false
    let paused = true

    function playAll() {
        for(let i=1; i<player.length; i++){
            if(player[i].currentTime() != player[i].duration()){
                player[i].play()
            }
            playing = true
            paused = false
        }
    }

    function pauseAll() {
        for(let i=1; i<player.length; i++){
            player[i].pause()
        }
        paused = true
    }

    function reset() {
        startTime()
        playTimer=0
        setTimeout(playAll,100)

        
    }

    function startTime() {
        for(let i=1; i<player.length; i++){
            player[i].currentTime(document.getElementById('st'+i).getAttribute('data-stime'))
        }

    }

    function stopAll() {
        for(let i=1; i<player.length; i++){
            player[i].stop()
            startTime()
            playing = false
            playToggleBtn.src='./play.svg'
        }
    }

</script> 

<br><br><br>
<%- include("../partials/footer")  %>